name: Velopack Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # vpk tool requires modern .NET runtimes

      - name: Set Console to UTF-8
        run: chcp 65001
        shell: pwsh

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Restore Dependencies
        run: dotnet restore

      - name: Publish Application
        run: |
          dotnet publish IsTakipWpf.csproj -c Release -r win-x64 --self-contained false -p:PublishReadyToRun=false -o ./publish
        # Note: We use -r win-x64 because Velopack works best with RID-specific builds

      - name: Pack with Velopack
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          # Ensure UTF8 for Turkish characters in filename
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          if (Test-Path "app_icon.ico") {
            Copy-Item "app_icon.ico" -Destination "./publish/"
          }
          
          vpk pack -u IsTakipApp -v $version -p ./publish -e "Ä°ÅŸ Takip UygulamasÄ±.exe" --icon "./publish/app_icon.ico"
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            Releases/*.exe
            Releases/*.msi
            Releases/RELEASES
            Releases/*.nupkg
            Releases/*.json
          generate_release_notes: true
          body: |
            # ğŸš€ Ä°ÅŸ Takip UygulamasÄ± - v1.0.5 (Final Kalite SÃ¼rÃ¼mÃ¼)
            
            Bu sÃ¼rÃ¼m, uygulamanÄ±n en kararlÄ± ve geliÅŸmiÅŸ halidir. KullanÄ±cÄ± deneyimi ve veri gÃ¼venliÄŸi Ã¶n planda tutularak hazÄ±rlanan bu gÃ¼ncelleme, Ã¶nemli altyapÄ± iyileÅŸtirmeleri iÃ§ermektedir.

            ### âœ¨ Yenilikler ve Ä°yileÅŸtirmeler:
            - **ğŸ’ Veri ve Lisans GÃ¼venliÄŸi:** Uygulama artÄ±k veritabanÄ±nÄ± ve lisans bilgilerini `%APPDATA%\Roaming` klasÃ¶rÃ¼nde saklayarak, uygulama dosyalarÄ± temizlense bile verilerinizin ve lisansÄ±nÄ±zÄ±n korunmasÄ±nÄ± saÄŸlar.
            - **âš¡ Performans:** XAML binding hatalarÄ± ve UI gecikmeleri giderildi, daha akÄ±cÄ± bir arayÃ¼z saÄŸlandÄ±.
            - **ğŸ”„ AkÄ±llÄ± GÃ¼ncelleme:** Velopack entegrasyonu optimize edildi, artÄ±k gÃ¼ncellemeler daha gÃ¼venli ve hÄ±zlÄ±.
            - **ğŸ› ï¸ Hata DÃ¼zeltmeleri:** Dashboard verilerindeki hesaplama hatalarÄ± ve Ã§eÅŸitli gÃ¶rsel aksaklÄ±klar giderildi.

            ### ğŸ“¦ Kurulum NotlarÄ±:
            1. Mevcut sÃ¼rÃ¼mÃ¼nÃ¼zÃ¼ kaldÄ±rmadan `v1.0.5-Setup.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rabilirsiniz.
            2. GÃ¼ncelleme sonrasÄ± tÃ¼m eski verileriniz ve lisans bilgileriniz otomatik olarak tanÄ±nacaktÄ±r.
            
            ---
            *Ä°ÅŸletmenizi modernleÅŸtirmeye devam ediyoruz.*
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
